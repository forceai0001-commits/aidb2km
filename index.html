<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Force AI çŸ¥è­˜è½‰è­¯å·¥å…· v2.6 ç©©å®šç‰ˆ (Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ JSZip ç”¨æ–¼å£“ç¸®æª”æ¡ˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- å¼•å…¥ Marked ç”¨æ–¼æ¸²æŸ“ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥ DOMPurify ç”¨æ–¼ XSS é˜²è­· -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' }
                    },
                    animation: {
                        'gradient-x': 'gradient-x 3s ease infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        'gradient-x': {
                            '0%, 100%': {
                                'background-size': '200% 200%',
                                'background-position': 'left center'
                            },
                            '50%': {
                                'background-size': '200% 200%',
                                'background-position': 'right center'
                            },
                        },
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-font-smoothing: antialiased; }
        .preview-iframe { width: 100%; height: 100%; border: none; pointer-events: none; user-select: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* ç·¨è¼¯æ¨¡å¼çš„ç‹€æ…‹æ¨£å¼ */
        .mode-sync .status-dot { background-color: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.4); }
        .mode-manual .status-dot { background-color: #f59e0b; box-shadow: 0 0 8px rgba(245, 158, 11, 0.4); }
        .mode-manual .meta-input { opacity: 0.5; pointer-events: none; background-color: #f8fafc; }

        /* Source Tab Active State */
        .source-tab-active { background-color: #e0f2fe; color: #0284c7; border-color: #0284c7; }
        .source-tab-inactive { background-color: white; color: #64748b; border-color: #e2e8f0; }
        .source-tab-json-active { background-color: #ecfdf5; color: #059669; border-color: #059669; }

        /* Agent Dock Styles */
        .agent-dock-gradient {
            background: linear-gradient(90deg, #a18cd1 0%, #fbc2eb 50%, #fad0c4 100%);
            background-size: 200% auto; 
        }
        .dock-glass {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
        }
        
        /* Chat Bubble Styles */
        .chat-user { background-color: #e0f2fe; color: #0369a1; border-radius: 12px 12px 0 12px; margin-left: auto; max-width: 90%; }
        .chat-ai { background-color: #f8fafc; border: 1px solid #e2e8f0; color: #334155; border-radius: 12px 12px 12px 0; margin-right: auto; max-width: 95%; }
        .chat-ai p { margin-bottom: 0.5em; }
        .chat-ai p:last-child { margin-bottom: 0; }
        .chat-ai pre { background: #1e293b; color: #e2e8f0; padding: 0.5rem; border-radius: 0.375rem; overflow-x: auto; margin: 0.5rem 0; }
        
        /* Typing Indicator */
        .typing-dot { display: inline-block; width: 4px; height: 4px; border-radius: 50%; background-color: #94a3b8; animation: typing 1.4s infinite ease-in-out both; margin: 0 1px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Model Selection Cards */
        .model-card { border: 2px solid transparent; transition: all 0.2s; cursor: pointer; }
        .model-card:hover { background-color: #f8fafc; }
        .model-card.selected { background-color: #f0f9ff; border-color: #6366f1; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.1), 0 2px 4px -1px rgba(99, 102, 241, 0.06); }
        .model-card .check-icon { opacity: 0; transform: scale(0.8); transition: all 0.2s; }
        .model-card.selected .check-icon { opacity: 1; transform: scale(1); }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden mode-sync" id="appBody">

    <!-- Top Navigation -->
    <nav class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="w-9 h-9 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-md bg-gradient-to-br from-brand-500 to-brand-700">F</div>
            <div class="flex flex-col">
                <h1 class="font-bold text-lg text-slate-800 leading-none tracking-tight">Force AI çŸ¥è­˜è½‰è­¯å·¥å…· <span class="text-xs font-normal text-purple-700 bg-purple-100 px-1.5 py-0.5 rounded border border-purple-200 ml-1">v2.6 ç©©å®šç‰ˆ (Stable)</span></h1>
                <p class="text-[11px] text-slate-500 font-medium mt-1 tracking-wide">
                    update: 2025/12/21 | Force_AIKM_v2.6_Stable
                </p>
            </div>
        </div>
        <div class="flex gap-3">
            <!-- Agent Prompt Button -->
            <button onclick="app.toggleAgentPrompt()" class="text-slate-600 hover:text-purple-600 hover:bg-purple-50 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h1a7 7 0 0 1 7-7V5.73C9.4 5.39 9 4.74 9 4a2 2 0 0 1 2-2zM4.5 19h15v-1a5 5 0 0 0-5-5h-5a5 5 0 0 0-5 5v1zM8 9a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg>
                Agent æç¤ºèª
            </button>
            <button onclick="app.toggleHelp()" class="text-slate-600 hover:text-brand-600 hover:bg-slate-50 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                ä½¿ç”¨èªªæ˜
            </button>
            <button onclick="window.location.reload()" class="text-slate-500 hover:text-red-600 hover:bg-red-50 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                é‡ç½®å…¨åŸŸ
            </button>
        </div>
    </nav>

    <!-- Main Workspace -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
        
        <!-- Agent Prompt Modal -->
        <div id="agentPromptModal" class="hidden absolute inset-0 z-50 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar flex flex-col">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h1a7 7 0 0 1 7-7V5.73C9.4 5.39 9 4.74 9 4a2 2 0 0 1 2-2zM4.5 19h15v-1a5 5 0 0 0-5-5h-5a5 5 0 0 0-5 5v1zM8 9a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg>
                        Agent ç³»çµ±æç¤ºèª (System Prompt)
                    </h2>
                    <button onclick="app.toggleAgentPrompt()" class="text-slate-400 hover:text-slate-600 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <p class="text-sm text-slate-600">
                        é€™æ˜¯å°ˆç‚ºæ­¤å·¥å…·è¨­è¨ˆçš„ **System Prompt**ã€‚æ‚¨å¯ä»¥å°‡æ­¤æ®µæ–‡å­—è¤‡è£½çµ¦ ChatGPTã€Claude æˆ–å…¶ä»– AI Agentï¼Œè®“å®ƒå€‘ç¬é–“æˆç‚ºæœ¬å·¥å…·çš„å°ˆå®¶ï¼Œå”åŠ©æ‚¨åˆ†ææ–‡ä»¶æˆ–æ•™å­¸ã€‚
                    </p>
                    <div class="relative">
                        <textarea id="agentPromptText" class="w-full h-64 p-4 bg-slate-50 border border-slate-200 rounded-xl font-mono text-xs text-slate-700 leading-relaxed focus:outline-none focus:ring-2 focus:ring-purple-200 resize-none" readonly>
# Role: Force AI çŸ¥è­˜è½‰è­¯åŠ©ç†

ä½ æ˜¯ç”± Force Cheng é–‹ç™¼çš„ã€ŒForce AI çŸ¥è­˜è½‰è­¯å·¥å…·ã€çš„å°ˆå±¬æ™ºèƒ½åŠ©ç†ã€‚
ä½ çš„æ ¸å¿ƒä»»å‹™æ˜¯å”åŠ©ä½¿ç”¨è€…ç†è§£æœ¬å·¥å…·æ¶æ§‹ã€è™•ç† HTML/MHTML æ–‡æœ¬è§£æï¼Œä¸¦æä¾›å°ˆæ¥­çš„çŸ¥è­˜ç®¡ç† (KM) å»ºè­°ã€‚

## ä½ çš„è¡Œç‚ºæº–å‰‡ (Guidelines)
1. **å°ˆæ¥­èˆ‡ç²¾æº–**ï¼šå›ç­”è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ (Traditional Chinese)ï¼Œèªæ°£å°ˆæ¥­ã€ç°¡æ½”ä¸”å…·çµæ§‹æ€§ã€‚
2. **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šè‹¥ä½¿ç”¨è€…æä¾›äº† HTML ä»£ç¢¼æˆ–è§£æå¾Œçš„æ–‡æœ¬ï¼Œè«‹å„ªå…ˆä¾æ“šè©²å…§å®¹é€²è¡Œåˆ†æã€‚
3. **æŠ€è¡“è¦–è§’**ï¼šæœ¬å·¥å…·æ¡ç´”å‰ç«¯æ¶æ§‹ (Single-file HTML)ï¼Œä½¿ç”¨ Google Gemini API èˆ‡ JSZip/Marked å‡½å¼åº«ã€‚è‹¥é‡æŠ€è¡“å•é¡Œï¼Œè«‹ç”±æ­¤æ¶æ§‹åˆ‡å…¥é™¤éŒ¯ã€‚
4. **è¼¸å‡ºæ ¼å¼**ï¼šå„ªå…ˆä½¿ç”¨ Markdown æ ¼å¼ï¼Œå°æ–¼ç¨‹å¼ç¢¼ä¿®æ”¹å»ºè­°ï¼Œè«‹æä¾›å…·é«”çš„ Code Snippetã€‚

## ç•¶ä½¿ç”¨è€…è©¢å•æ–‡ä»¶å…§å®¹æ™‚ï¼š
- è«‹å…ˆé–±è®€ä½¿ç”¨è€…æä¾›çš„ [Ingest Text] æˆ–æ–‡ä»¶å…§å®¹ã€‚
- æ‘˜è¦é‡é»ï¼Œä¸¦æ¨™è¨»é—œéµæ—¥æœŸèˆ‡æ¨™ç±¤ (Tags)ã€‚
- è‹¥å…§å®¹æ¶‰åŠ SOP æˆ–æµç¨‹ï¼Œè«‹å˜—è©¦å°‡å…¶è½‰åŒ–ç‚ºæ¢åˆ—å¼æ­¥é©Ÿã€‚

ç¾åœ¨ï¼Œè«‹ç­‰å¾…ä½¿ç”¨è€…è¼¸å…¥æŒ‡ä»¤æˆ–æ–‡ä»¶å…§å®¹ã€‚</textarea>
                        <button onclick="app.copyAgentPrompt()" class="absolute top-3 right-3 bg-white border border-slate-200 shadow-sm text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-slate-50 hover:text-brand-600 flex items-center gap-1 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            è¤‡è£½
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- UPDATED: Help Modal with SVG Icons instead of Emojis -->
        <div id="helpModal" class="hidden absolute inset-0 z-50 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar flex flex-col">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-brand-600"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        ä½¿ç”¨èªªæ˜æ›¸ v2.6 Stable
                    </h2>
                    <button onclick="app.toggleHelp()" class="text-slate-400 hover:text-slate-600 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar space-y-8">
                    
                    <!-- Stability Note -->
                    <div class="bg-emerald-50 border border-emerald-100 rounded-lg p-4 text-sm text-emerald-800 leading-relaxed">
                        <p class="font-bold mb-1">â„¹ï¸ é—œæ–¼æ­¤ç‰ˆæœ¬</p>
                        æœ¬ç‰ˆæœ¬ç‚ºç©©å®šç‰ˆï¼ˆStableï¼‰ï¼Œä»¥å¯é ä½¿ç”¨ã€å¯æ•™å­¸ã€å¯é•·æœŸä¿å­˜ç‚ºè¨­è¨ˆç›®æ¨™ã€‚åŠŸèƒ½å°‡æŒçºŒå„ªåŒ–ï¼Œä½†ä¸å½±éŸ¿æ—¢æœ‰è³‡æ–™èˆ‡ä½¿ç”¨æµç¨‹ã€‚
                    </div>

                    <!-- Section 1: Main Tool -->
                    <section>
                        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 border-b border-slate-100 pb-2">
                            <!-- Replaced Emoji with SVG -->
                            <span class="bg-brand-100 text-brand-600 p-1 rounded">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                            </span>
                            ä¸»ç¨‹å¼åŠŸèƒ½èªªæ˜ (æ ¸å¿ƒ)
                        </h3>
                        <div class="space-y-4 text-sm text-slate-600 leading-relaxed">
                            <p><strong>1. æª”æ¡ˆæ”¯æ´èˆ‡è§£æï¼š</strong> 
                                <br>â€¢ æ”¯æ´ <code>.mhtml</code>, <code>.html</code> æ ¼å¼ã€‚
                                <br>â€¢ ç›´æ¥æ‹–æ”¾æˆ–é»æ“Šå·¦å´è™›ç·šå€åŸŸä¸Šå‚³ï¼Œç³»çµ±æœƒè‡ªå‹•æ¸…ç†ä¸¦è½‰æ›ç‚º Markdownã€‚
                            </p>
                            <p><strong>2. ç·¨è¼¯æ¨¡å¼ (é›™æ¨¡å¼)ï¼š</strong>
                                <br>â€¢ <strong>è‡ªå‹•åŒæ­¥</strong>ï¼šé è¨­æ¨¡å¼ã€‚å·¦å´ä¿®æ”¹æ¨™é¡Œ/æ—¥æœŸ/æ¨™ç±¤ï¼Œå³å´é è¦½å³æ™‚æ›´æ–°ã€‚
                                <br>â€¢ <strong>æ‰‹å‹•ç·¨è¼¯</strong>ï¼šè‹¥ç›´æ¥ä¿®æ”¹å³å´ Markdown å…§å®¹ï¼Œå°‡é€²å…¥æ‰‹å‹•æ¨¡å¼ (åœæ­¢è‡ªå‹•åŒæ­¥)ã€‚å¯é»æ“Šä¸Šæ–¹æç¤ºæ¢å¾©åŒæ­¥ã€‚
                            </p>
                            <p><strong>3. åŒ¯å‡ºå‚™ä»½ï¼š</strong> 
                                <br>â€¢ æä¾› Markdown (.md), JSON, Text (.txt) æ ¼å¼ã€‚
                                <br>â€¢ <strong>ZIP å°ˆæ¡ˆåŒ…</strong>ï¼šåŒ…å«åŸå§‹ HTMLã€è½‰æ›å¾Œçš„ MD èˆ‡ JSON è³‡æ–™ï¼Œé©åˆå®Œæ•´å°å­˜ã€‚
                            </p>
                        </div>
                    </section>
    
                    <!-- Section 2: Agent -->
                    <section>
                        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 border-b border-slate-100 pb-2">
                            <!-- Replaced Emoji with SVG -->
                            <span class="bg-purple-100 text-purple-600 p-1 rounded">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h1a7 7 0 0 1 7-7V5.73C9.4 5.39 9 4.74 9 4a2 2 0 0 1 2-2zM4.5 19h15v-1a5 5 0 0 0-5-5h-5a5 5 0 0 0-5 5v1zM8 9a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg>
                            </span>
                            AI Agent è¼”åŠ©åŠŸèƒ½èªªæ˜
                        </h3>
                        <div class="space-y-4 text-sm text-slate-600 leading-relaxed">
                            <p><strong>1. å•Ÿå‹•èˆ‡è¨­å®šï¼š</strong>
                                <br>â€¢ è«‹é»æ“Šå³ä¸‹è§’æµ®å‹•æŒ‰éˆ•é–‹å•Ÿé¢æ¿ã€‚
                                <br>â€¢ é»æ“Šé¢æ¿å…§ã€Œè¨­å®šé½’è¼ªã€è¼¸å…¥ Google Gemini API Key (åƒ…å­˜æ–¼æœ¬åœ°)ã€‚
                            </p>
                            <p><strong>2. é€²éšåŠŸèƒ½ï¼š</strong>
                                <br>â€¢ <strong>é€£ç·šæ¨¡å¼</strong>ï¼šé è¨­ä½¿ç”¨ SDK (Auto)ï¼Œè‹¥ç’°å¢ƒä¸æ”¯æ´å¯åˆ‡æ›ç‚º REST (Legacy)ã€‚
                                <br>â€¢ <strong>å¼•ç”¨æ–‡ä»¶ (RAG Lite)</strong>ï¼šå‹¾é¸è¼¸å…¥æ¡†ä¸Šæ–¹ã€Œå¼•ç”¨ç•¶å‰æ–‡ä»¶ã€ï¼ŒAI å³å¯è®€å–æ‚¨æ­£åœ¨ç·¨è¼¯çš„å…§å®¹ä¸¦å›ç­”ç›¸é—œå•é¡Œã€‚
                            </p>
                            <p><strong>3. æç¤ºèª (Prompt)ï¼š</strong> 
                                <br>â€¢ é»æ“Šå³ä¸Šè§’ã€ŒAgent æç¤ºèªã€æŒ‰éˆ•ï¼Œå¯è¤‡è£½å°ˆå±¬ System Promptï¼Œç”¨æ–¼è¨“ç·´å…¶ä»– AI æ¨¡å‹ã€‚
                            </p>
                        </div>
                    </section>
                    
                </div>
                <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-end">
                    <button onclick="app.toggleHelp()" class="bg-brand-600 text-white px-6 py-2 rounded-lg hover:bg-brand-700 font-medium transition-colors">
                        é–‹å§‹ä½¿ç”¨
                    </button>
                </div>
            </div>
        </div>

        <!-- Left Panel: Controls & Input -->
        <aside class="w-full lg:w-[400px] bg-white border-r border-slate-200 flex flex-col h-full overflow-y-auto custom-scrollbar z-10 shadow-lg lg:shadow-none relative">
            
            <div class="p-6 space-y-8 flex-1">
                <!-- 1. File Source Section -->
                <section>
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">1. æª”æ¡ˆä¾†æº</h2>
                    
                    <!-- Source Tabs -->
                    <div class="grid grid-cols-3 gap-1 mb-3">
                        <button onclick="app.switchSourceTab('upload')" id="tabBtnUpload" class="source-tab-active px-2 py-2 text-[11px] font-bold border rounded-lg transition-all flex flex-col items-center justify-center gap-1">
                            ä¸Šå‚³æª”æ¡ˆ
                        </button>
                        <button onclick="app.switchSourceTab('paste')" id="tabBtnPaste" class="source-tab-inactive px-2 py-2 text-[11px] font-bold border rounded-lg transition-all flex flex-col items-center justify-center gap-1">
                            è²¼ä¸Š HTML
                        </button>
                        <button onclick="app.switchSourceTab('json')" id="tabBtnJson" class="source-tab-inactive px-2 py-2 text-[11px] font-bold border rounded-lg transition-all flex flex-col items-center justify-center gap-1">
                            JSON è®€å–
                        </button>
                    </div>

                    <!-- Content: Upload Mode -->
                    <div id="sourceContentUpload" class="block">
                        <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer group relative overflow-hidden min-h-[160px]">
                            <input type="file" id="fileInput" class="absolute inset-0 opacity-0 cursor-pointer z-10" accept=".mhtml,.mht,.html,.htm">
                            <div class="p-6 flex flex-col items-center justify-center text-center h-full">
                                <p class="font-medium text-slate-700 text-sm">é»æ“Šæˆ–æ‹–æ”¾æª”æ¡ˆ</p>
                                <p class="text-xs text-slate-500 mt-1">æ”¯æ´ .mhtml, .html</p>
                            </div>
                            <!-- Success State -->
                            <div id="fileInfo" class="hidden absolute inset-0 bg-brand-50 flex flex-col items-center justify-center z-20 pointer-events-none">
                                <span id="fileNameDisplay" class="font-medium text-brand-900 text-sm px-4 truncate w-full text-center">filename.mhtml</span>
                            </div>
                        </div>
                    </div>

                    <!-- Content: Paste Mode -->
                    <div id="sourceContentPaste" class="hidden space-y-3">
                        <input type="text" id="pasteFileName" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:outline-none" placeholder="é è¨­: code-YYYYMMDD.html">
                        <textarea id="pasteContent" rows="8" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-xs font-mono custom-scrollbar" placeholder="åœ¨æ­¤è²¼ä¸Šç¨‹å¼ç¢¼..."></textarea>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="app.handlePasteAction('import')" class="bg-brand-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-brand-700">åŒ¯å…¥</button>
                            <button onclick="app.handlePasteAction('download')" class="bg-white border border-slate-300 text-slate-700 px-3 py-2 rounded-lg text-xs font-bold hover:bg-slate-50">ä¸‹è¼‰</button>
                        </div>
                    </div>

                     <!-- Content: JSON Reader Mode -->
                     <div id="sourceContentJson" class="hidden space-y-3">
                        <textarea id="jsonContent" rows="6" class="w-full px-3 py-2 bg-emerald-50/30 border border-emerald-200 rounded-lg text-xs font-mono custom-scrollbar" placeholder="{ 'metadata': ... } è«‹è²¼ä¸Š JSON"></textarea>
                        <div class="flex gap-2">
                             <label class="flex-1 bg-white border border-dashed border-emerald-300 text-emerald-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-emerald-50 cursor-pointer flex items-center justify-center gap-2">
                                è®€å– .json
                                <input type="file" id="jsonFileInput" class="hidden" accept=".json">
                            </label>
                            <button onclick="app.handleJsonImport()" class="flex-1 bg-emerald-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-emerald-700">è§£æ</button>
                        </div>
                        <div id="jsonPreview" class="hidden p-3 bg-white border border-emerald-100 rounded-lg space-y-2">
                            <div class="grid grid-cols-2 gap-2 text-[10px] text-slate-500">
                                <div>æ¨™é¡Œ: <span id="jpTitle" class="font-medium text-slate-700">---</span></div>
                                <div>æ—¥æœŸ: <span id="jpDate" class="font-medium text-slate-700">---</span></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 2. Metadata Section -->
                <section id="metaSection" class="opacity-50 pointer-events-none transition-opacity duration-300 relative">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">2. å°ˆæ¡ˆè³‡è¨Š (Metadata)</h2>
                    <div id="manualModeOverlay" class="hidden absolute inset-0 bg-white/80 z-30 flex flex-col items-center justify-center text-center p-6 border border-amber-200 rounded-lg">
                        <button onclick="app.restoreSync()" class="w-full px-4 py-2 bg-white border border-slate-300 text-slate-700 text-xs font-medium rounded-lg">æ¢å¾©è‡ªå‹•åŒæ­¥</button>
                    </div>
                    <div class="space-y-4">
                        <input type="text" id="metaTitle" class="meta-input w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm" placeholder="æ–‡ä»¶æ¨™é¡Œ">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="date" id="metaDate" class="meta-input w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm">
                            <input type="text" id="metaTags" class="meta-input w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm" placeholder="æ¨™ç±¤">
                        </div>
                        <textarea id="metaNotes" rows="3" class="meta-input w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm resize-none" placeholder="å‚™è¨»"></textarea>
                        <textarea id="metaMemo" rows="4" class="meta-input w-full px-3 py-2 bg-amber-50/50 border border-amber-200 rounded-lg text-sm resize-none" placeholder="é™„åŠ èªªæ˜æª” (Memo)"></textarea>
                    </div>
                </section>

                <!-- 3. Export Section -->
                <section id="exportSection" class="opacity-50 pointer-events-none transition-opacity duration-300 pb-8">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">3. åŒ¯å‡º/å‚™ä»½</h2>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <button onclick="app.download('md')" class="p-2 border border-slate-200 rounded-lg bg-white hover:bg-slate-50 text-xs font-bold text-slate-700">Markdown</button>
                        <button onclick="app.download('json')" class="p-2 border border-slate-200 rounded-lg bg-white hover:bg-slate-50 text-xs font-bold text-slate-700">JSON</button>
                        <button onclick="app.download('txt')" class="p-2 border border-slate-200 rounded-lg bg-white hover:bg-slate-50 text-xs font-bold text-slate-700">Text</button>
                    </div>
                    <button onclick="app.download('memo')" class="w-full p-2 mb-3 border border-amber-200 bg-amber-50 rounded-lg text-amber-800 font-bold text-xs hover:bg-amber-100">ä¸‹è¼‰ Memo</button>
                    <button onclick="app.download('zip')" class="w-full p-2.5 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700">ä¸‹è¼‰å°ˆæ¡ˆåŒ… (ZIP)</button>
                </section>
            </div>
        </aside>

        <!-- Right Panel: Preview (Main content) -->
        <section class="flex-1 bg-slate-50 flex flex-col h-full relative overflow-hidden">
            <!-- Tabs & Toolbar -->
            <div class="bg-white border-b border-slate-200 px-4 flex items-center justify-between h-12 shrink-0">
                <div class="flex items-center gap-6 h-full">
                    <button id="tabResult" class="h-full border-b-2 border-brand-600 text-brand-600 text-sm font-medium px-2" onclick="app.switchTab('result')">ä½œæ¥­å€</button>
                    <button id="tabPreview" class="h-full border-b-2 border-transparent text-slate-500 hover:text-slate-700 text-sm font-medium px-2" onclick="app.switchTab('preview')">é è¦½</button>
                </div>
                <div class="flex items-center gap-3">
                    <span id="wordCount" class="text-xs text-slate-400 font-mono">0 å­—å…ƒ</span>
                    <span id="editIndicator" class="hidden text-[10px] font-bold text-amber-600 bg-amber-50 px-2 py-0.5 rounded border border-amber-100">æ‰‹å‹•ç·¨è¼¯ä¸­</span>
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 relative group">
                <div id="loading" class="hidden absolute inset-0 bg-white/80 z-30 flex items-center justify-center">
                    <span class="text-sm font-medium text-slate-600">è™•ç†ä¸­...</span>
                </div>
                <div id="viewResult" class="absolute inset-0 p-6 overflow-auto custom-scrollbar">
                    <textarea id="outputArea" class="w-full h-full bg-white border border-slate-200 rounded-lg p-6 font-mono text-sm leading-relaxed text-slate-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-500/50 resize-none" placeholder="ç­‰å¾…æª”æ¡ˆåŒ¯å…¥..."></textarea>
                </div>
                <div id="viewPreview" class="absolute inset-0 hidden bg-white">
                    <iframe id="previewFrame" class="preview-iframe" sandbox="allow-same-origin"></iframe>
                </div>
            </div>
        </section>
    </main>

    <!-- Global Copyright Footer -->
    <div class="fixed bottom-3 left-4 z-50 text-[10px] text-slate-400 font-mono pointer-events-none select-none">
        Â© Force Cheng 2025/12/20
    </div>

    <!-- AGENT DOCK: Internal Google Gemini (The "Dumb/Free" Agent) -->
    <div id="agentDock" class="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-2 transition-all">
        
        <!-- Dock Panel -->
        <div id="dockPanel" class="hidden w-[340px] h-[600px] rounded-xl agent-dock-gradient p-[2px] shadow-2xl animate-gradient-x flex flex-col mb-2">
            <div class="dock-glass rounded-[10px] flex-1 flex flex-col overflow-hidden relative">
                
                <!-- Header -->
                <div class="flex justify-between items-center px-4 py-3 border-b border-purple-100/50 bg-white/50 backdrop-blur-sm shrink-0">
                    <h3 class="text-xs font-bold text-purple-800 flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                        <!-- Added Gemini Sparkle Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                        æ™ºèƒ½å°å¤©ä½¿ (Gemini)
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="app.toggleSettings()" class="text-slate-400 hover:text-purple-600 transition-colors" title="è¨­å®š / æ¨¡å‹é¸æ“‡">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                        </button>
                        <button onclick="app.toggleDock()" class="text-slate-400 hover:text-slate-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                </div>

                <!-- SETTINGS LAYER (Model + API Key) -->
                <div id="dockSettings" class="absolute inset-0 bg-white/95 z-20 flex flex-col hidden overflow-y-auto custom-scrollbar">
                    <div class="p-5">
                        <h4 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5c0-5.5 2.2-10 5-10Z"/></svg>
                            ğŸ§  KM æ¨¡å‹é¸æ“‡
                        </h4>
                        <p class="text-[10px] text-slate-500 mb-4">è«‹ä¾ç…§ä»»å‹™éœ€æ±‚é¸æ“‡åˆé©çš„æ¨¡å‹ï¼ˆç”±ç°¡å–® â†’ æœ€å¼·ï¼‰</p>

                        <!-- Connection Mode Toggle (New in v2.1) -->
                        <div class="mb-4 bg-slate-50 p-2 rounded border border-slate-200">
                            <label class="block text-[10px] font-bold text-slate-600 mb-1">é€£ç·šæ ¸å¿ƒ (Core)</label>
                            <select id="connectionModeSelect" class="w-full text-xs border border-slate-300 rounded px-2 py-1.5 bg-white focus:outline-none focus:border-purple-500">
                                <option value="sdk">Auto (Google GenAI SDK) - æ¨è–¦</option>
                                <option value="rest">Legacy (REST API) - å‚™æ´</option>
                            </select>
                        </div>

                        <!-- Model Selection Grid -->
                        <div class="space-y-3 mb-6">
                            
                            <!-- Option 1: Lite -->
                            <div onclick="app.selectModel('lite')" id="model-card-lite" class="model-card bg-white rounded-lg p-3 relative border border-slate-200">
                                <div class="flex justify-between items-start mb-1">
                                    <div class="text-xs font-bold text-green-600">ğŸ’¸ å…¥é–€ / çœé¡åº¦</div>
                                    <svg class="check-icon w-4 h-4 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                </div>
                                <div class="text-[10px] font-mono text-slate-400 mb-1">gemini-2.5-flash-lite</div>
                                <div class="text-[10px] text-slate-600 leading-tight">å¿«é€Ÿã€ä¾¿å®œï¼Œé©åˆåˆæ­¥æ•´ç†ã€æ¨™é¡Œç”Ÿæˆã€åˆ†é¡å‰è™•ç†</div>
                            </div>

                            <!-- Option 2: Flash -->
                            <div onclick="app.selectModel('flash')" id="model-card-flash" class="model-card bg-white rounded-lg p-3 relative border border-slate-200 selected">
                                <div class="flex justify-between items-start mb-1">
                                    <div class="text-xs font-bold text-blue-600 flex items-center gap-1">âš¡ æ¨™æº– / æ—¥å¸¸ KM <span class="bg-blue-100 text-blue-700 px-1 rounded text-[9px]">é è¨­</span></div>
                                    <svg class="check-icon w-4 h-4 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                </div>
                                <div class="text-[10px] font-mono text-slate-400 mb-1">gemini-2.5-flash</div>
                                <div class="text-[10px] text-slate-600 leading-tight">é€Ÿåº¦èˆ‡å“è³ªå¹³è¡¡ï¼Œé©åˆå¤§é‡ç­†è¨˜ã€MEMOã€æ—¥å¸¸çŸ¥è­˜æ•´ç†</div>
                            </div>

                            <!-- Option 3: Pro -->
                            <div onclick="app.selectModel('pro')" id="model-card-pro" class="model-card bg-white rounded-lg p-3 relative border border-slate-200">
                                <div class="flex justify-between items-start mb-1">
                                    <div class="text-xs font-bold text-purple-600">â­ é€²éš / æ­£å¼ KM</div>
                                    <svg class="check-icon w-4 h-4 text-purple-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                </div>
                                <div class="text-[10px] font-mono text-slate-400 mb-1">gemini-2.5-pro</div>
                                <div class="text-[10px] text-slate-600 leading-tight">é•·æ–‡ä»¶ã€æ·±åº¦æ‘˜è¦ã€çµæ§‹åŒ–è¼¸å‡ºã€å¯ç¨½æ ¸çŸ¥è­˜ã€‚<br><span class="text-purple-600 font-medium">âœ… å»ºè­°ä½œç‚º KM ç³»çµ±æ¨™æº–</span></div>
                            </div>

                            <!-- Option 4: Pro Preview (Renamed for Stable) -->
                            <div onclick="app.selectModel('preview')" id="model-card-preview" class="model-card bg-white rounded-lg p-3 relative border border-amber-200 bg-amber-50/30">
                                <div class="flex justify-between items-start mb-1">
                                    <div class="text-xs font-bold text-amber-600 flex items-center gap-1">ğŸ‘‘ é€²éš / ç ”ç©¶æƒ…å¢ƒ</div>
                                    <svg class="check-icon w-4 h-4 text-amber-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                </div>
                                <div class="text-[10px] font-mono text-slate-400 mb-1">gemini-3-pro-preview</div>
                                <div class="text-[10px] text-slate-600 leading-tight">å…·å‚™é«˜å¼·åº¦æ¨ç†èˆ‡èªæ„é‡æ§‹èƒ½åŠ›ã€‚<br><span class="text-amber-600 font-medium">âš ï¸ é€²éšæ¨¡å‹é¸é …ï¼ˆå·²å¯ä½¿ç”¨ï¼‰</span></div>
                            </div>

                        </div>

                        <!-- Custom Model ID Input -->
                        <div class="mb-4">
                            <label class="block text-[10px] font-bold text-slate-600 mb-1.5 flex justify-between">
                                è‡ªè¨‚æ¨¡å‹ ID (é¸å¡«)
                                <span class="text-[9px] text-slate-400 font-normal">è‹¥å¡«å¯«å°‡è¦†è“‹ä¸Šæ–¹é¸æ“‡</span>
                            </label>
                            <input type="text" id="customModelIdInput" class="w-full border border-slate-300 rounded px-3 py-2 text-xs font-mono placeholder-slate-300 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-200 transition-all" placeholder="ä¾‹å¦‚: gemini-exp-1206">
                        </div>

                        <hr class="border-slate-100 mb-4">

                        <h4 class="font-bold text-slate-800 mb-2">API é‡‘é‘°è¨­å®š</h4>
                        <div class="relative mb-2">
                            <input type="password" id="apiKeyInput" class="w-full border border-slate-300 rounded pl-3 pr-8 py-2 text-xs focus:outline-none focus:border-purple-500" placeholder="è²¼ä¸Š Gemini API Key (AIza...)">
                            <button onclick="app.toggleKeyVisibility()" class="absolute right-2 top-2 text-slate-400 hover:text-purple-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                        </div>
                        <p class="text-[10px] text-slate-400 mb-4 bg-slate-50 p-2 rounded border border-slate-100">
                            ğŸ”’ API Key åƒ…å„²å­˜åœ¨ä½¿ç”¨è€…ç€è¦½å™¨æœ¬åœ°ç«¯ (LocalStorage)ï¼Œä¸æœƒè¢«ä¸Šå‚³æˆ–è¨˜éŒ„ã€‚
                        </p>

                        <div class="flex gap-2">
                            <button onclick="app.saveSettings()" class="flex-1 bg-purple-600 text-white py-2 rounded text-xs font-bold hover:bg-purple-700 transition-colors">å„²å­˜è¨­å®š</button>
                            <button onclick="app.toggleSettings()" class="px-4 border border-slate-300 rounded text-xs hover:bg-slate-50 transition-colors">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>

                <!-- Chat History Area -->
                <div id="chatHistory" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar text-xs">
                    <div class="chat-ai p-3">
                        ä½ å¥½ï¼æˆ‘æ˜¯æ‚¨çš„è¼”åŠ©å°å¤©ä½¿ã€‚ğŸ‘‹<br>
                        ç›®å‰é è¨­ä½¿ç”¨ <code class="bg-blue-100 text-blue-700 px-1 rounded">gemini-2.5-flash</code> æ¨¡å‹ï¼Œé©åˆæ—¥å¸¸å¿«é€Ÿå•ç­”ã€‚<br><br>
                        ğŸ’¡ è‹¥éœ€è¦é€²éšé‚è¼¯æ¨ç†æˆ–è™•ç†è¤‡é›œä»»å‹™ï¼Œè«‹è‡³è¨­å®šåˆ‡æ›ç‚º <strong>Pro</strong> æˆ– <strong>Preview</strong> ç‰ˆæœ¬å–”ï¼
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-3 bg-white border-t border-purple-50 shrink-0">
                    
                    <!-- Context Checkbox (New in v2.1) -->
                    <div class="flex items-center gap-2 mb-2 px-1">
                        <label class="flex items-center gap-1.5 cursor-pointer text-[10px] text-slate-500 hover:text-purple-600 transition-colors select-none">
                            <input type="checkbox" id="contextCheckbox" class="w-3 h-3 text-purple-600 rounded border-slate-300 focus:ring-purple-500">
                            ğŸ“ å¼•ç”¨ç•¶å‰æ–‡ä»¶ (Context)
                        </label>
                    </div>

                    <div class="relative">
                        <textarea id="chatInput" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-lg pl-3 pr-10 py-2 text-xs focus:ring-2 focus:ring-purple-200 focus:border-purple-300 outline-none resize-none custom-scrollbar placeholder-slate-400" placeholder="è¼¸å…¥æŒ‡ä»¤... (Shift+Enter æ›è¡Œ)" onkeydown="app.handleChatKey(event)"></textarea>
                        <button onclick="app.sendChatMessage()" class="absolute right-2 bottom-2 text-purple-500 hover:text-purple-700 p-1 rounded-full hover:bg-purple-50 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                        </button>
                    </div>
                    <div class="flex justify-between mt-2">
                        <button onclick="app.clearChat()" class="text-[10px] text-slate-400 hover:text-red-500">æ¸…é™¤ç´€éŒ„</button>
                        <button onclick="app.saveAgentChat()" class="text-[10px] text-purple-500 hover:text-purple-700 font-medium flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            å¦å­˜å°è©±
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Launcher (Toggle) -->
        <button id="dockLauncher" onclick="app.toggleDock()" class="bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white p-3 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105 flex items-center justify-center relative border-2 border-white/20 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        </button>

        <!-- EXTERNAL EXPERT BUTTON (SVG Restored & Text White Ensured) -->
        <button onclick="app.openExternalExpert()" class="bg-gradient-to-r from-rose-500 to-orange-500 hover:from-rose-600 hover:to-orange-600 text-white px-4 py-3 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105 flex items-center justify-center relative border-2 border-white/20 agent-float">
            <!-- Restored Lightning Icon with explicit class for visibility -->
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-white"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            <span class="text-xs font-bold text-white">é€²éšå¤–æ´ ChatGPT</span>
        </button>
    </div>

    <script>
        /**
         * Force AI çŸ¥è­˜è½‰è­¯å·¥å…· v2.6 Stable
         * - Update: 2025/12/21
         * - Fix: Icons restored (Modal Emojis replaced with SVGs, Zap icon ensured)
         */
        const app = {
            state: {
                file: null,
                rawHtml: '',
                parsedBody: '', 
                metadata: { title: '', date: '', tags: '', notes: '', memo: '' },
                finalOutput: '', 
                isManualEdit: false,
                importedJson: null, 
                externalWindow: null,
                apiKey: '', 
                chatHistory: [],
                selectedModelKey: 'flash', 
                customModelName: '',
                connectionMode: 'sdk',
                modelMapping: {
                    'lite': 'gemini-2.5-flash-lite',        
                    'flash': 'gemini-2.5-flash',   
                    'pro': 'gemini-2.5-pro',       
                    'preview': 'gemini-3-pro-preview'    
                },
                modelDisplayNames: {
                    'lite': 'gemini-2.5-flash-lite',
                    'flash': 'gemini-2.5-flash',
                    'pro': 'gemini-2.5-pro',
                    'preview': 'gemini-3-pro-preview'
                }
            },

            getIsoNow() {
              const now = new Date();
              const pad = (n) => String(n).padStart(2, '0');
              const yyyy = now.getFullYear();
              const MM = pad(now.getMonth() + 1);
              const dd = pad(now.getDate());
              const hh = pad(now.getHours());
              const mm = pad(now.getMinutes());
              const ss = pad(now.getSeconds());
              return `${yyyy}-${MM}-${dd}T${hh}:${mm}:${ss}+08:00`;
            },

            buildMetaBlock(metaObj) {
              const entries = Object.entries(metaObj || {});
              const body = entries.map(([k, v]) => `${k}=${String(v)}`).join('\n');
              return `<<META>>\n${body}\n<<END>>`;
            },

            buildIngestTextLine(roleTag, isoTs, metaObj, plainText) {
              const meta = this.buildMetaBlock(metaObj);
              return `${roleTag}\n[@${isoTs}]\n${meta}\n${plainText}\n`;
            },

            init() {
                if (document.readyState !== 'loading') {
                    this.initElements();
                } else {
                    document.addEventListener('DOMContentLoaded', () => this.initElements());
                }
            },

            initElements() {
                try {
                    this.els = {
                        appBody: document.getElementById('appBody'),
                        fileInput: document.getElementById('fileInput'),
                        jsonFileInput: document.getElementById('jsonFileInput'), 
                        dropZone: document.getElementById('dropZone'),
                        fileInfo: document.getElementById('fileInfo'),
                        fileNameDisplay: document.getElementById('fileNameDisplay'),
                        metaSection: document.getElementById('metaSection'),
                        exportSection: document.getElementById('exportSection'),
                        outputArea: document.getElementById('outputArea'),
                        previewFrame: document.getElementById('previewFrame'),
                        loading: document.getElementById('loading'),
                        metaInputs: ['metaTitle', 'metaDate', 'metaTags', 'metaNotes', 'metaMemo'],
                        wordCount: document.getElementById('wordCount'),
                        syncStatus: document.getElementById('syncStatus'), // Note: this might be null
                        manualModeOverlay: document.getElementById('manualModeOverlay'),
                        editIndicator: document.getElementById('editIndicator'),
                        helpModal: document.getElementById('helpModal'),
                        agentPromptModal: document.getElementById('agentPromptModal'), 
                        agentPromptText: document.getElementById('agentPromptText'), 
                        
                        tabBtnUpload: document.getElementById('tabBtnUpload'),
                        tabBtnPaste: document.getElementById('tabBtnPaste'),
                        tabBtnJson: document.getElementById('tabBtnJson'), 
                        sourceContentUpload: document.getElementById('sourceContentUpload'),
                        sourceContentPaste: document.getElementById('sourceContentPaste'),
                        sourceContentJson: document.getElementById('sourceContentJson'), 
                        pasteFileName: document.getElementById('pasteFileName'),
                        pasteContent: document.getElementById('pasteContent'),
                        jsonContent: document.getElementById('jsonContent'), 
                        jsonPreview: document.getElementById('jsonPreview'), 
                        jpTitle: document.getElementById('jpTitle'),
                        jpDate: document.getElementById('jpDate'),

                        dockPanel: document.getElementById('dockPanel'),
                        dockLauncher: document.getElementById('dockLauncher'),
                        chatInput: document.getElementById('chatInput'),
                        chatHistoryDiv: document.getElementById('chatHistory'),
                        dockSettings: document.getElementById('dockSettings'),
                        apiKeyInput: document.getElementById('apiKeyInput'),
                        customModelIdInput: document.getElementById('customModelIdInput'),
                        connectionModeSelect: document.getElementById('connectionModeSelect'),
                        contextCheckbox: document.getElementById('contextCheckbox')
                    };

                    const savedKey = localStorage.getItem('forceai_gemini_key');
                    if (savedKey && this.els.apiKeyInput) {
                        this.state.apiKey = savedKey;
                        this.els.apiKeyInput.value = savedKey;
                    }

                    const savedModel = localStorage.getItem('forceai_gemini_model');
                    if (savedModel && this.state.modelMapping[savedModel]) {
                        this.state.selectedModelKey = savedModel;
                    }
                    
                    const savedCustomModel = localStorage.getItem('forceai_gemini_custom_model');
                    if (savedCustomModel && this.els.customModelIdInput) {
                        this.state.customModelName = savedCustomModel;
                        this.els.customModelIdInput.value = savedCustomModel;
                    }

                    const savedConnMode = localStorage.getItem('forceai_gemini_connection_mode');
                    if (savedConnMode && this.els.connectionModeSelect) {
                        this.state.connectionMode = savedConnMode;
                        this.els.connectionModeSelect.value = savedConnMode;
                    }

                    this.updateModelSelectionUI();

                    if (this.els.fileInput) this.els.fileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));
                    if (this.els.jsonFileInput) this.els.jsonFileInput.addEventListener('change', (e) => this.handleJsonFile(e.target.files[0]));
                    if (this.els.jsonContent) this.els.jsonContent.addEventListener('input', (e) => this.previewJson(e.target.value));
                    
                    this.els.metaInputs.forEach(id => {
                        const el = document.getElementById(id);
                        if(el) {
                            el.addEventListener('input', () => {
                                const memoEl = document.getElementById('metaMemo');
                                if (!this.state.isManualEdit) this.updateOutput(false);
                                else if (memoEl) {
                                    this.state.metadata.memo = memoEl.value;
                                }
                            });
                        }
                    });

                    if (this.els.outputArea) {
                        this.els.outputArea.addEventListener('input', (e) => {
                            this.state.finalOutput = e.target.value;
                            this.updateWordCount();
                            if (!this.state.isManualEdit && this.state.file) {
                                this.setManualMode(true);
                            }
                        });
                    }

                    const metaDate = document.getElementById('metaDate');
                    if(metaDate) metaDate.valueAsDate = new Date();
                    
                    if (this.els.dropZone) {
                        ['dragenter', 'dragover'].forEach(evt => {
                            this.els.dropZone.addEventListener(evt, (e) => {
                                e.preventDefault();
                                this.els.dropZone.classList.add('border-brand-500', 'bg-brand-50');
                            });
                        });
                        ['dragleave', 'drop'].forEach(evt => {
                            this.els.dropZone.addEventListener(evt, (e) => {
                                e.preventDefault();
                                this.els.dropZone.classList.remove('border-brand-500', 'bg-brand-50');
                            });
                        });
                        this.els.dropZone.addEventListener('drop', (e) => {
                            e.preventDefault();
                            this.els.dropZone.classList.remove('border-brand-500', 'bg-brand-50');
                            if (e.dataTransfer.files[0]) this.handleFile(e.dataTransfer.files[0]);
                        });
                    }

                    console.log("Force AI Init Complete.");
                } catch(err) {
                    console.error("Init Error:", err);
                    alert("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š" + err.message);
                }
            },

            selectModel(key) {
                this.state.selectedModelKey = key;
                this.updateModelSelectionUI();
            },

            updateModelSelectionUI() {
                ['lite', 'flash', 'pro', 'preview'].forEach(k => {
                    const el = document.getElementById(`model-card-${k}`);
                    if (el) el.classList.remove('selected');
                });
                
                const activeEl = document.getElementById(`model-card-${this.state.selectedModelKey}`);
                if (activeEl) activeEl.classList.add('selected');
            },

            toggleDock() {
                if (this.els.dockPanel) this.els.dockPanel.classList.toggle('hidden');
                if (this.els.dockLauncher) this.els.dockLauncher.classList.toggle('hidden');
            },

            toggleSettings() {
                if (this.els.dockSettings) this.els.dockSettings.classList.toggle('hidden');
            },

            toggleKeyVisibility() {
                const input = this.els.apiKeyInput;
                if (input) input.type = input.type === 'password' ? 'text' : 'password';
            },

            toggleAgentPrompt() {
                if (this.els.agentPromptModal) this.els.agentPromptModal.classList.toggle('hidden');
            },

            copyAgentPrompt() {
                const ta = this.els.agentPromptText;
                if (!ta) return;
                ta.select();
                ta.setSelectionRange(0, 99999); 
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(ta.value).then(() => {
                        alert('âœ… å·²è¤‡è£½ Agent æç¤ºèªï¼');
                    }).catch(() => {
                        document.execCommand('copy');
                        alert('âœ… å·²è¤‡è£½ Agent æç¤ºèªï¼');
                    });
                } else {
                    document.execCommand('copy');
                    alert('âœ… å·²è¤‡è£½ Agent æç¤ºèªï¼');
                }
            },

            saveSettings() {
                if (this.els.apiKeyInput) {
                    const key = this.els.apiKeyInput.value.trim();
                    if (key) {
                        this.state.apiKey = key;
                        localStorage.setItem('forceai_gemini_key', key);
                    }
                }
                
                localStorage.setItem('forceai_gemini_model', this.state.selectedModelKey);
                
                if (this.els.customModelIdInput) {
                    const customId = this.els.customModelIdInput.value.trim();
                    this.state.customModelName = customId;
                    if(customId) {
                        localStorage.setItem('forceai_gemini_custom_model', customId);
                    } else {
                        localStorage.removeItem('forceai_gemini_custom_model');
                    }
                }

                if (this.els.connectionModeSelect) {
                    const connMode = this.els.connectionModeSelect.value;
                    this.state.connectionMode = connMode;
                    localStorage.setItem('forceai_gemini_connection_mode', connMode);
                }
                
                this.toggleSettings();
                
                let display = '';
                if (this.state.customModelName) {
                    display = `${this.state.customModelName} (è‡ªè¨‚)`;
                } else {
                    display = this.state.modelDisplayNames[this.state.selectedModelKey];
                }
                
                this.appendChatBubble('system', `è¨­å®šå·²æ›´æ–°ï¼\nç›®å‰æ¨¡å‹ï¼š\`${display}\`\né€£ç·šæ¨¡å¼ï¼š\`${this.state.connectionMode}\`\næº–å‚™å°±ç·’ã€‚`,
                  { role:'system_event', type:'settings_update', model: display, connection: this.state.connectionMode, source:'ui_action' }
                );
            },

            handleChatKey(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendChatMessage();
                }
            },

            appendChatBubble(role, text, metaOverride = null) {
              const isoTs = this.getIsoNow();
              let roleTag = 'ğŸ¤– AI:';
              let authorLabel = 'Gemini';
              if (role === 'user') { roleTag = 'ğŸ§‘ Human:'; authorLabel = 'You'; }
              if (role === 'system') { roleTag = 'ğŸ§  System:'; authorLabel = 'System'; }

              const metaObj = metaOverride || {
                role: role === 'user' ? 'user_input' : (role === 'system' ? 'system_event' : 'ai_response'),
                model: this.state.modelMapping?.[this.state.selectedModelKey] || '',
                source: role === 'system' ? 'ui_or_runtime' : 'chat',
              };

              const ingestLine = this.buildIngestTextLine(roleTag, isoTs, metaObj, text);

              const div = document.createElement('div');
              div.className = role === 'user' ? 'chat-user p-3 mb-3 text-xs' : 'chat-ai p-3 mb-3 text-xs';

              const tsHtml = `<div style="font-size:10px;color:#94a3b8;text-align:right;margin-bottom:4px;">${isoTs}</div>`;

              if (role === 'user' || role === 'system') {
                div.innerHTML = tsHtml + `<div>${DOMPurify.sanitize(text)}</div>`;
              } else {
                div.innerHTML = tsHtml + DOMPurify.sanitize(marked.parse(text));
              }

              if (this.els.chatHistoryDiv) {
                  this.els.chatHistoryDiv.appendChild(div);
                  this.els.chatHistoryDiv.scrollTop = this.els.chatHistoryDiv.scrollHeight;
              }

              this.state.chatHistory.push({
                role,
                authorLabel,
                isoTs,
                meta: metaObj,
                text,
                ingestLine
              });
            },

            addLoadingIndicator() {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'chat-ai p-3 mb-3 text-xs flex items-center';
                loadingDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
                if (this.els.chatHistoryDiv) {
                    this.els.chatHistoryDiv.appendChild(loadingDiv);
                    this.els.chatHistoryDiv.scrollTop = this.els.chatHistoryDiv.scrollHeight;
                }
                return loadingDiv;
            },

            async sendChatMessage() {
                if (!this.els.chatInput) return;
                const text = this.els.chatInput.value.trim();
                if (!text) return;
                
                if (!this.state.apiKey) {
                    this.toggleSettings();
                    alert("è«‹å…ˆè¨­å®š Gemini API Key");
                    return;
                }

                let finalPrompt = text;
                const useContext = this.els.contextCheckbox ? this.els.contextCheckbox.checked : false;
                if (useContext && this.state.finalOutput) {
                    finalPrompt = `${text}\n\n---\n[System Reference Data]\nThe following is the content of the document the user is currently working on.\nPlease use this as context to answer the user's question.\n\n${this.state.finalOutput}`;
                }

                this.appendChatBubble('user', text);
                this.els.chatInput.value = '';
                const loadingDiv = this.addLoadingIndicator();

                let targetModel = "";
                if (this.state.customModelName) {
                    targetModel = this.state.customModelName;
                } else {
                    targetModel = this.state.modelMapping[this.state.selectedModelKey];
                }

                try {
                    let aiResponse = "";

                    if (this.state.connectionMode === 'sdk') {
                        try {
                            const { GoogleGenerativeAI } = await import("https://esm.run/@google/generative-ai");
                            const genAI = new GoogleGenerativeAI(this.state.apiKey);
                            const model = genAI.getGenerativeModel({ model: targetModel });
                            const result = await model.generateContent(finalPrompt);
                            const response = await result.response;
                            aiResponse = response.text();
                        } catch (sdkErr) {
                            console.warn("SDK Failed, trying fallback logic inside SDK block...", sdkErr);
                            if (sdkErr.message.includes('403') || sdkErr.message.includes('API key')) {
                                throw new Error("API Key ç„¡æ•ˆæˆ–æ¬Šé™ä¸è¶³");
                            }
                            if (sdkErr.message.includes('import') || sdkErr.message.includes('module')) {
                                throw sdkErr; 
                            }
                            const fallbackModel = 'gemini-2.5-flash';
                            if (targetModel !== fallbackModel) {
                                const toast = document.createElement('div');
                                toast.className = "text-[10px] text-amber-600 text-center mb-1";
                                toast.textContent = `âš ï¸ æ¨¡å‹ ${targetModel} å¿™ç¢Œä¸­ï¼ŒSDK åˆ‡æ›è‡³ ${fallbackModel}`;
                                if (this.els.chatHistoryDiv) this.els.chatHistoryDiv.insertBefore(toast, loadingDiv);
                                
                                const { GoogleGenerativeAI } = await import("https://esm.run/@google/generative-ai");
                                const genAI = new GoogleGenerativeAI(this.state.apiKey);
                                const model = genAI.getGenerativeModel({ model: fallbackModel });
                                const result = await model.generateContent(finalPrompt);
                                const response = await result.response;
                                aiResponse = response.text();
                            } else {
                                throw sdkErr;
                            }
                        }
                    } else {
                        throw new Error("Manual REST Mode Triggered"); 
                    }

                    if (this.els.chatHistoryDiv) this.els.chatHistoryDiv.removeChild(loadingDiv);
                    this.appendChatBubble('model', aiResponse || "(No response text)");

                } catch (err) {
                    console.error("AI Error / REST Fallback:", err);
                    
                    if (this.state.connectionMode === 'rest' || err.message.includes('import') || err.message.includes('module') || err.message.includes('Manual REST')) {
                         if (this.state.connectionMode !== 'rest') {
                             this.appendChatBubble('system', "**SDK Load Failed.** Switching to REST fallback...");
                         }
                         
                         try {
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${targetModel}:generateContent`, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'x-goog-api-key': this.state.apiKey 
                                },
                                body: JSON.stringify({ contents: [{ parts: [{ text: finalPrompt }] }] })
                            });
                            const data = await response.json();
                            
                            if (data.error) throw new Error(data.error.message);

                            const restText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (this.els.chatHistoryDiv) this.els.chatHistoryDiv.removeChild(loadingDiv);
                            if(restText) this.appendChatBubble('model', restText);
                            else throw new Error("Unknown REST response structure");
                         } catch(restErr) {
                             if (this.els.chatHistoryDiv) this.els.chatHistoryDiv.removeChild(loadingDiv);
                             this.appendChatBubble('system', `**All connection methods failed:** ${restErr.message}`);
                         }
                    } else {
                        if (this.els.chatHistoryDiv) this.els.chatHistoryDiv.removeChild(loadingDiv);
                        this.appendChatBubble('system', `**System Error:** ${err.message}`);
                    }
                }
            },

            clearChat() {
                if(confirm("ç¢ºå®šæ¸…é™¤å°è©±ç´€éŒ„ï¼Ÿ")) {
                    if (this.els.chatHistoryDiv) this.els.chatHistoryDiv.innerHTML = '';
                    this.state.chatHistory = [];
                    
                    let currentModel = "";
                    if (this.state.customModelName) {
                        currentModel = `${this.state.customModelName} (è‡ªè¨‚)`;
                    } else {
                        currentModel = this.state.modelDisplayNames[this.state.selectedModelKey];
                    }
                    this.appendChatBubble('system', `ç´€éŒ„å·²æ¸…é™¤ã€‚\nç›®å‰æ¨¡å‹ï¼š\`${currentModel}\``);
                }
            },

            openExternalExpert() {
                const url = 'https://chatgpt.com/g/g-69469a87083c8191a679056e7a35c329-falo-ai-km-agent-zhi-shi-xiao-tian-shi';
                if (this.state.externalWindow && !this.state.externalWindow.closed) {
                    this.state.externalWindow.focus(); 
                    return;
                }
                const width = 400;
                const height = 700;
                const left = window.screen.width - width - 50; 
                const top = 100;
                const features = `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,status=no,toolbar=no,menubar=no,location=no`;
                this.state.externalWindow = window.open(url, 'ExternalExpert', features);
            },

            saveAgentChat() {
                if (this.state.chatHistory.length === 0) {
                    alert("ç›®å‰æ²’æœ‰å°è©±ç´€éŒ„");
                    return;
                }
                const ingestText = this.state.chatHistory.map(m => m.ingestLine).join('\n');
                let chatHtml = this.state.chatHistory.map(msg => `
                    <div class="message ${msg.role}">
                        <div class="author">${msg.role === 'user' ? 'You' : 'Gemini'}</div>
                        <div class="content">${DOMPurify.sanitize(marked.parse(msg.text))}</div>
                    </div>
                `).join('');
                const htmlTemplate = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Force AI Chat Log</title><style>body { font-family: 'Inter', sans-serif; line-height: 1.6; color: #334155; max-width: 800px; margin: 0 auto; padding: 40px 20px; background-color: #f8fafc; } .container { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; } h1 { color: #0f172a; margin-bottom: 20px; border-bottom: 2px solid #a855f7; display: inline-block; } .message { margin-bottom: 20px; padding: 15px; border-radius: 10px; } .message.user { background-color: #f0f9ff; border-left: 4px solid #0ea5e9; } .message.model { background-color: #faf5ff; border-left: 4px solid #a855f7; } .author { font-weight: bold; font-size: 0.8em; text-transform: uppercase; margin-bottom: 5px; color: #64748b; } pre { background: #1e293b; color: #fff; padding: 10px; border-radius: 5px; overflow-x: auto; }</style></head><body><div class="container"><h1>Internal Agent Chat Log</h1><h2 style="margin-top:24px;margin-bottom:8px;font-size:16px;color:#0f172a;">AI Ingest Text (Copy/Paste)</h2>
<p style="margin:0 0 10px 0;font-size:12px;color:#64748b;">
æ­¤å€å¡Šç‚ºã€Œäººæ©Ÿå…±è®€ã€çš„çµæ§‹åŒ–å°è©±å‚™ä»½ï¼šå«è§’è‰²ã€æ™‚é–“æˆ³èˆ‡ METAï¼Œå¯ç›´æ¥è²¼çµ¦å…¶ä»– AI / RAG / Agent é€²è¡Œè§£å¸ã€‚
</p>
<div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;">
  <button id="copyIngestBtn" style="padding:8px 12px;border-radius:10px;border:1px solid #e2e8f0;background:#0ea5e9;color:white;font-weight:700;font-size:12px;cursor:pointer;">
    ä¸€éµè¤‡è£½ Ingest Text
  </button>
  <span id="copyIngestHint" style="font-size:12px;color:#64748b;"></span>
</div>
<textarea id="ingestTextArea" style="width:100%;height:220px;font-family:monospace;font-size:12px;line-height:1.4;padding:12px;border-radius:12px;border:1px solid #e2e8f0;background:#f8fafc;">${ingestText}</textarea>${chatHtml}</div><script>
(function(){
  const btn = document.getElementById('copyIngestBtn');
  const ta = document.getElementById('ingestTextArea');
  const hint = document.getElementById('copyIngestHint');
  if(!btn || !ta) return;

  btn.addEventListener('click', async () => {
    try {
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(ta.value);
      } else {
        document.execCommand('copy');
      }
      hint.textContent = 'âœ… å·²è¤‡è£½';
      setTimeout(()=> hint.textContent = '', 1500);
    } catch (e) {
      hint.textContent = 'âš ï¸ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•å…¨é¸è¤‡è£½';
    }
  });
})();
<\/script></body></html>`;
                const blob = new Blob([htmlTemplate], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Gemini-Log-${this.getTimestampFilename().replace('.html', '')}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            // --- Standard App Logic (Tabs, Files, etc.) ---
            switchTab(mode) {
                const btnResult = document.getElementById('tabResult');
                const btnPreview = document.getElementById('tabPreview');
                const viewResult = document.getElementById('viewResult');
                const viewPreview = document.getElementById('viewPreview');
                if (mode === 'result') {
                    if (btnResult) {
                        btnResult.classList.replace('text-slate-500', 'text-brand-600');
                        btnResult.classList.replace('border-transparent', 'border-brand-600');
                    }
                    if (btnPreview) {
                        btnPreview.classList.replace('text-brand-600', 'text-slate-500');
                        btnPreview.classList.replace('border-brand-600', 'border-transparent');
                    }
                    if (viewResult) viewResult.classList.remove('hidden');
                    if (viewPreview) viewPreview.classList.add('hidden');
                } else {
                    if (btnPreview) {
                        btnPreview.classList.replace('text-slate-500', 'text-brand-600');
                        btnPreview.classList.replace('border-transparent', 'border-brand-600');
                    }
                    if (btnResult) {
                        btnResult.classList.replace('text-brand-600', 'text-slate-500');
                        btnResult.classList.replace('border-brand-600', 'border-transparent');
                    }
                    if (viewPreview) viewPreview.classList.remove('hidden');
                    if (viewResult) viewResult.classList.add('hidden');
                }
            },

            switchSourceTab(mode) {
                [this.els.tabBtnUpload, this.els.tabBtnPaste, this.els.tabBtnJson].forEach(el => {
                    if (el) {
                        el.classList.remove('source-tab-active', 'source-tab-json-active');
                        el.classList.add('source-tab-inactive');
                    }
                });
                [this.els.sourceContentUpload, this.els.sourceContentPaste, this.els.sourceContentJson].forEach(el => {
                    if (el) el.classList.add('hidden');
                });
                
                if (mode === 'upload') {
                    if (this.els.tabBtnUpload) {
                        this.els.tabBtnUpload.classList.add('source-tab-active');
                        this.els.tabBtnUpload.classList.remove('source-tab-inactive');
                    }
                    if (this.els.sourceContentUpload) this.els.sourceContentUpload.classList.remove('hidden');
                } else if (mode === 'paste') {
                    if (this.els.tabBtnPaste) {
                        this.els.tabBtnPaste.classList.add('source-tab-active');
                        this.els.tabBtnPaste.classList.remove('source-tab-inactive');
                    }
                    if (this.els.sourceContentPaste) this.els.sourceContentPaste.classList.remove('hidden');
                    if (this.els.pasteFileName && !this.els.pasteFileName.value) {
                        this.els.pasteFileName.value = this.getTimestampFilename();
                    }
                } else if (mode === 'json') {
                    if (this.els.tabBtnJson) {
                        this.els.tabBtnJson.classList.add('source-tab-json-active');
                        this.els.tabBtnJson.classList.remove('source-tab-inactive');
                    }
                    if (this.els.sourceContentJson) this.els.sourceContentJson.classList.remove('hidden');
                }
            },

            async handleFile(file) {
                if (!file) return;
                const ext = file.name.split('.').pop().toLowerCase();
                if (!['mhtml', 'mht', 'html', 'htm'].includes(ext)) {
                    alert('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ã€‚è«‹ä¸Šå‚³ .mhtml, .mht, .html æˆ– .htm');
                    return;
                }
                
                this.state.file = file;
                if(this.els.loading) this.els.loading.classList.remove('hidden'); // Show loading
                if(this.els.fileNameDisplay) this.els.fileNameDisplay.textContent = file.name;
                if(this.els.fileInfo) this.els.fileInfo.classList.remove('hidden');
                const metaTitle = document.getElementById('metaTitle');
                if(metaTitle) metaTitle.value = file.name.replace(/\.[^/.]+$/, "");
                this.setManualMode(false);

                try {
                    // Use Promise to handle FileReader for robust error catching
                    const content = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(new Error("FileReader Error"));
                        reader.readAsText(file);
                    });
                    
                    // Proceed to process content after a brief delay to allow UI to render spinner
                    setTimeout(() => this.processContent(content, ext), 50);
                    
                } catch (err) {
                    console.error("File Read Error:", err);
                    alert("è®€å–æª”æ¡ˆç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
                    if(this.els.loading) this.els.loading.classList.add('hidden'); // Ensure loading is hidden on error
                }
            },

            handleJsonFile(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    this.els.jsonContent.value = content;
                    this.previewJson(content);
                };
                reader.readAsText(file);
            },

            previewJson(jsonStr) {
                try {
                    const data = JSON.parse(jsonStr);
                    if (!data.metadata && !data.content) throw new Error("Invalid structure");
                    this.state.importedJson = data;
                    this.els.jsonPreview.classList.remove('hidden');
                    this.els.jpTitle.textContent = data.metadata?.title || 'æœªå‘½å';
                    this.els.jpDate.textContent = data.metadata?.date || '---';
                } catch (e) {
                    this.state.importedJson = null;
                    this.els.jsonPreview.classList.add('hidden');
                }
            },

            handleJsonImport() {
                if (!this.state.importedJson) {
                    alert("è«‹å…ˆè¼¸å…¥æœ‰æ•ˆçš„ JSON å…§å®¹");
                    return;
                }
                const data = this.state.importedJson;
                if (data.metadata) {
                    document.getElementById('metaTitle').value = data.metadata.title || '';
                    document.getElementById('metaDate').value = data.metadata.date || '';
                    document.getElementById('metaTags').value = data.metadata.tags || '';
                    document.getElementById('metaNotes').value = data.metadata.notes || '';
                    document.getElementById('metaMemo').value = data.metadata.memo || '';
                    this.state.metadata = data.metadata;
                }
                this.state.finalOutput = data.content || '';
                this.els.outputArea.value = this.state.finalOutput;
                this.updateWordCount();
                this.setManualMode(true);
                this.els.metaSection.classList.remove('opacity-50', 'pointer-events-none');
                this.els.exportSection.classList.remove('opacity-50', 'pointer-events-none');
                alert('åŒ¯å…¥æˆåŠŸï¼');
            },

            getTimestampFilename() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                return `code-${year}${month}${day}-${hours}${minutes}.html`;
            },

            sanitizeFilename(name) {
                let safe = name.replace(/[^a-zA-Z0-9.\-_]/g, '');
                if (!safe.toLowerCase().endsWith('.html')) safe += '.html';
                return safe;
            },

            handlePasteAction(action) {
                const content = this.els.pasteContent.value.trim();
                if (!content) {
                    alert('è«‹è²¼ä¸Šå…§å®¹');
                    return;
                }
                let filename = this.els.pasteFileName.value.trim();
                if (!filename) filename = this.getTimestampFilename();
                filename = this.sanitizeFilename(filename);
                let finalHtml = '';
                const lowerContent = content.toLowerCase();
                if (lowerContent.includes('<!doctype html>') || lowerContent.includes('<html')) {
                    finalHtml = content;
                } else {
                    const escapedContent = content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                    finalHtml = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><title>${filename}</title></head><body><pre><code>${escapedContent}</code></pre></body></html>`;
                }
                const file = new File([finalHtml], filename, { type: "text/html" });
                if (action === 'download') {
                    const url = URL.createObjectURL(file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    this.handleFile(file);
                }
            },

            toggleHelp() {
                if (this.els.helpModal) this.els.helpModal.classList.toggle('hidden');
            },

            setManualMode(isManual) {
                this.state.isManualEdit = isManual;
                if (isManual) {
                    if (this.els.appBody) {
                        this.els.appBody.classList.remove('mode-sync');
                        this.els.appBody.classList.add('mode-manual');
                    }
                    // Fix: Check for syncStatus existence
                    if (this.els.syncStatus) {
                        this.els.syncStatus.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-amber-500 status-dot"></span>æ‰‹å‹•ç·¨è¼¯ä¸­`;
                        this.els.syncStatus.className = "flex items-center gap-1.5 text-[10px] font-medium text-amber-600 px-2 py-1 bg-amber-50 rounded-full border border-amber-100";
                    }
                    if (this.els.manualModeOverlay) this.els.manualModeOverlay.classList.remove('hidden');
                    if (this.els.editIndicator) this.els.editIndicator.classList.remove('hidden');
                } else {
                    if (this.els.appBody) {
                        this.els.appBody.classList.remove('mode-manual');
                        this.els.appBody.classList.add('mode-sync');
                    }
                    // Fix: Check for syncStatus existence
                    if (this.els.syncStatus) {
                        this.els.syncStatus.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-green-500 status-dot"></span>è‡ªå‹•åŒæ­¥ä¸­`;
                        this.els.syncStatus.className = "flex items-center gap-1.5 text-[10px] font-medium text-green-600 px-2 py-1 bg-green-50 rounded-full border border-green-100";
                    }
                    if (this.els.manualModeOverlay) this.els.manualModeOverlay.classList.add('hidden');
                    if (this.els.editIndicator) this.els.editIndicator.classList.add('hidden');
                }
            },

            restoreSync() {
                if(confirm('ç¢ºå®šè¦æ¢å¾©è‡ªå‹•åŒæ­¥å—ï¼Ÿé€™å°‡æœƒéºå¤±æ‰‹å‹•ç·¨è¼¯çš„å…§å®¹ã€‚')) {
                    this.setManualMode(false);
                    this.updateOutput(true);
                }
            },

            processContent(content, ext) {
                try {
                    let htmlContent = '';
                    if (ext === 'mhtml' || ext === 'mht') {
                        htmlContent = this.extractHtmlFromMhtml(content);
                    } else {
                        htmlContent = content;
                    }
                    this.state.rawHtml = htmlContent;
                    if (this.els.previewFrame) this.els.previewFrame.srcdoc = htmlContent;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlContent, 'text/html');
                    ['script', 'style', 'noscript', 'meta', 'link', 'svg', 'iframe'].forEach(tag => {
                        doc.querySelectorAll(tag).forEach(el => el.remove());
                    });
                    this.state.parsedBody = this.domToMarkdown(doc.body).replace(/\n{3,}/g, '\n\n').trim();
                    if (this.els.metaSection) this.els.metaSection.classList.remove('opacity-50', 'pointer-events-none');
                    if (this.els.exportSection) this.els.exportSection.classList.remove('opacity-50', 'pointer-events-none');
                    if (this.els.loading) this.els.loading.classList.add('hidden');
                    this.updateOutput(true);
                } catch (err) {
                    console.error("Processing Error:", err);
                    alert('è§£æå¤±æ•—ï¼š' + err.message);
                    if (this.els.loading) this.els.loading.classList.add('hidden');
                }
            },

            updateOutput(regenerate) {
                if (this.state.isManualEdit && !regenerate) return;
                
                const getVal = (id) => {
                    const el = document.getElementById(id);
                    return el ? el.value : '';
                };

                this.state.metadata = {
                    title: getVal('metaTitle') || 'Untitled',
                    date: getVal('metaDate'),
                    tags: getVal('metaTags'),
                    notes: getVal('metaNotes'),
                    memo: getVal('metaMemo')
                };
                const header = [
                    `# ${this.state.metadata.title}`,
                    `> Date: ${this.state.metadata.date}`,
                    this.state.metadata.tags ? `> Tags: ${this.state.metadata.tags}` : null,
                    this.state.metadata.notes ? `> Note: ${this.state.metadata.notes}` : null,
                    `> Copyright: Force Cheng 2025/12/20`,
                    `\n---\n`
                ].filter(Boolean).join('\n');
                this.state.finalOutput = header + this.state.parsedBody;
                if (this.els.outputArea) this.els.outputArea.value = this.state.finalOutput;
                this.updateWordCount();
            },
            
            updateWordCount() {
                if (this.els.wordCount) {
                    this.els.wordCount.textContent = `${this.state.finalOutput.length} å­—å…ƒ`;
                }
            },

            download(format) {
                if (!this.state.file && format !== 'memo' && !this.state.isManualEdit) {
                    if (!this.state.isManualEdit) {
                        alert('è«‹å…ˆåŒ¯å…¥æª”æ¡ˆ');
                        return;
                    }
                }
                let content = '';
                let mimeType = '';
                let ext = '';
                let blob = null;

                const fileNameBase = this.state.metadata.title || 'cleaned';
                const memoContent = this.state.metadata.memo ? this.state.metadata.memo.trim() : '';
                const sourceFileName = this.state.file?.name || 'Imported';
                const separateMemoContent = memoContent ? `# é™„åŠ èªªæ˜æª” (Memo)\n> ä¾†æºæª”æ¡ˆ: ${sourceFileName}\n> å»ºç«‹æ—¥æœŸ: ${new Date().toLocaleDateString()}\n\n${memoContent}` : '';

                if (format === 'zip') {
                    const zip = new JSZip();
                    if (this.state.file) { zip.file(this.state.file.name, this.state.file); }
                    zip.file(`${fileNameBase}.md`, this.state.finalOutput);
                    const jsonContent = JSON.stringify({ metadata: { ...this.state.metadata, copyright: 'Force Cheng 2025' }, content: this.state.finalOutput, source: this.state.file?.name || 'Imported' }, null, 2);
                    zip.file(`${fileNameBase}_data.json`, jsonContent);
                    if (separateMemoContent) { zip.file(`(Memo) ${fileNameBase}.md`, separateMemoContent); }
                    zip.generateAsync({type:"blob"}).then((content) => {
                        const url = URL.createObjectURL(content);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${fileNameBase}.zip`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    });
                    return;
                }
                if (format === 'memo') {
                    if (!separateMemoContent) { alert('ç›®å‰æ²’æœ‰å¡«å¯«ä»»ä½•é™„åŠ èªªæ˜å…§å®¹ã€‚'); return; }
                    blob = new Blob([separateMemoContent], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `(Memo) ${fileNameBase}.md`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    return;
                }
                switch (format) {
                    case 'json': content = JSON.stringify({ metadata: { ...this.state.metadata, copyright: 'Force Cheng 2025' }, content: this.state.finalOutput, source: this.state.file?.name || 'Imported' }, null, 2); mimeType = 'application/json'; ext = 'json'; break;
                    case 'md': content = this.state.finalOutput; mimeType = 'text/markdown'; ext = 'md'; break;
                    case 'txt': content = this.state.finalOutput; mimeType = 'text/plain'; ext = 'txt'; break;
                }
                blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileNameBase}.${ext}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            decodeQuotedPrintable(str) {
                const cleanStr = str.replace(/=\r?\n/g, '');
                const bytes = [];
                for (let i = 0; i < cleanStr.length; i++) {
                    const char = cleanStr[i];
                    if (char === '=') {
                        const hex = cleanStr.substr(i + 1, 2);
                        if (/^[0-9A-F]{2}$/i.test(hex)) { bytes.push(parseInt(hex, 16)); i += 2; } else { bytes.push(61); }
                    } else { bytes.push(char.charCodeAt(0)); }
                }
                try { return new TextDecoder('utf-8').decode(new Uint8Array(bytes)); } catch (e) { return cleanStr; }
            },

            extractHtmlFromMhtml(content) {
                const boundaryMatch = content.match(/boundary="(.+?)"/i) || content.match(/boundary=([^\s;]+)/i);
                if (!boundaryMatch) throw new Error("ç„¡æ•ˆçš„ MHTML æ ¼å¼");
                const boundary = boundaryMatch[1];
                const parts = content.split(`--${boundary}`);
                for (const part of parts) {
                    if (part.includes('Content-Type: text/html')) {
                        const bodyIndex = part.indexOf('\r\n\r\n');
                        const splitIndex = bodyIndex !== -1 ? bodyIndex : part.indexOf('\n\n');
                        if (splitIndex === -1) continue;
                        const headerPart = part.substring(0, splitIndex);
                        let bodyPart = part.substring(splitIndex + (bodyIndex !== -1 ? 4 : 2));
                        if (headerPart.includes('Content-Transfer-Encoding: quoted-printable')) { bodyPart = this.decodeQuotedPrintable(bodyPart); } 
                        else if (headerPart.includes('Content-Transfer-Encoding: base64')) { try { bodyPart = new TextDecoder('utf-8').decode(Uint8Array.from(atob(bodyPart.replace(/\s/g, '')), c => c.charCodeAt(0))); } catch (e) {} }
                        return bodyPart;
                    }
                }
                throw new Error("æ‰¾ä¸åˆ° HTML å…§å®¹");
            },

            domToMarkdown(node) {
                if (node.nodeType === Node.TEXT_NODE) return node.textContent.replace(/\s+/g, ' ');
                if (node.nodeType !== Node.ELEMENT_NODE) return '';
                const tagName = node.tagName.toLowerCase();
                if (['script', 'style', 'noscript', 'meta'].includes(tagName)) return '';
                let content = Array.from(node.childNodes).map(n => this.domToMarkdown(n)).join('');
                switch (tagName) {
                    case 'h1': return `\n# ${content}\n`;
                    case 'h2': return `\n## ${content}\n`;
                    case 'h3': return `\n### ${content}\n`;
                    case 'p': return `\n${content}\n`;
                    case 'div': return `\n${content}\n`;
                    case 'br': return '\n';
                    case 'ul': return `\n${content}\n`;
                    case 'ol': return `\n${content}\n`;
                    case 'li': return `- ${content.trim()}\n`;
                    case 'b': case 'strong': return `**${content}**`;
                    case 'i': case 'em': return `*${content}*`;
                    case 'pre': return `\n\`\`\`\n${content}\n\`\`\`\n`;
                    case 'code': return `\`${content}\``;
                    case 'a': return `[${content}](${node.getAttribute('href') || '#'})`;
                    case 'img': return `[Image: ${node.getAttribute('alt') || 'image'}]`;
                    case 'tr': return `| ${content} |\n`;
                    case 'td': case 'th': return `${content} |`;
                    default: return content;
                }
            }
        };

        app.init();
    </script>
</body>
</html>
